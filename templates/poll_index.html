{% extends "base.html" %}
{% block title %}CLAAMP Poll{% endblock %}
{% block content %}

<section class="container stack">

  <!-- Hero / Status Card -->
  <div class="card index-hero">
    <header class="index-hero__head">
      <div class="index-hero__titlewrap">
        <h1 class="index-hero__title">Friends AP Poll</h1>
        {% if open_poll %}
          <span class="pill pill-live" aria-label="Poll is open">Open</span>
        {% else %}
          <span class="pill pill-muted" aria-label="No open poll">Closed</span>
        {% endif %}
      </div>

      {% if open_poll %}
        <p class="index-hero__subtitle">
          Current: <strong>{{ open_poll.title }}</strong>
          <span class="muted">({{ open_poll.season }} â€¢ Week {{ open_poll.week }})</span>
        </p>
      {% else %}
        <p class="index-hero__subtitle muted">No open poll right now.</p>
      {% endif %}
    </header>

    {% if open_poll %}
      {% if user_ballot and user_ballot.submitted_at %}
        <div class="index-actions">
          <p class="muted mb-0">Thanks â€” your ballot is in.</p>

          <div class="action-tray" role="group" aria-label="Ballot actions">
            <a class="tray-btn" href="{{ url_for('poll.vote_form') }}">
              <span class="tray-btn__icon" aria-hidden="true">âœï¸</span>
              <span class="tray-btn__label">Edit Ballot</span>
            </a>

            <!-- IMPORTANT: link to specific poll id results -->
            <a class="tray-btn tray-btn--primary" href="{{ url_for('poll.results_by_id', poll_id=open_poll.id) }}">
              <span class="tray-btn__icon" aria-hidden="true">ğŸ“Š</span>
              <span class="tray-btn__label">See Current Results</span>
            </a>

            <a class="tray-btn tray-btn--ghost"
               href="{{ url_for('poll.share_ballot_png', ballot_id=user_ballot.id) }}"
               target="_blank" download>
              <span class="tray-btn__icon" aria-hidden="true">ğŸ“¸</span>
              <span class="tray-btn__label">Share Image</span>
            </a>
          </div>
        </div>
      {% else %}
        <div class="index-actions">
          <p class="muted mb-0">Cast your ballot to shape this weekâ€™s rankings.</p>

          <div class="action-tray" role="group" aria-label="Poll actions">
            <a class="tray-btn tray-btn--primary tray-btn--glow" href="{{ url_for('poll.vote_form') }}">
              <span class="tray-btn__icon" aria-hidden="true">ğŸ—³ï¸</span>
              <span class="tray-btn__label">Vote Now</span>
            </a>

            {% if open_poll %}
              <a class="tray-btn tray-btn--ghost" href="{{ url_for('poll.results_by_id', poll_id=open_poll.id) }}">
                <span class="tray-btn__icon" aria-hidden="true">ğŸ‘€</span>
                <span class="tray-btn__label">See Current Results</span>
              </a>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endif %}
  </div>

  <!-- Latest Past Results -->
  {% if latest_past_poll %}
    <div class="card">
      <header class="split-row">
        <div>
          <h3 class="mb-0">Most Recent Results</h3>
          <p class="muted mt-0">{{ latest_past_poll.title }}</p>
        </div>
        <div class="align-end">
          <!-- IMPORTANT: link to the specific past poll id -->
          <a class="btn" href="{{ url_for('poll.results_by_id', poll_id=latest_past_poll.id) }}">View Results</a>
        </div>
      </header>
    </div>
  {% endif %}

  <!-- Quick link: browse all polls -->
  <div class="card">
    <div class="split-row">
      <div>
        <h3 class="mb-0">All Polls</h3>
        <p class="muted mt-0 small">Browse and open any pollâ€™s results.</p>
      </div>
      <div class="align-end">
        <a class="btn" href="{{ url_for('poll.poll_list') }}">Open Poll Directory</a>
      </div>
    </div>
  </div>

  <!-- Admin quick-open tools (visible only to admins) -->
  {% if current_user.is_authenticated and current_user.is_admin %}
    <div class="card">
      <h3 class="mb-0">Admin</h3>
      <p class="muted mt-0 small">Open a new poll or (re)seed teams.</p>

      <form method="post"
            action="{{ url_for('poll.admin_new_poll') }}"
            class="form-grid mt-2"
            autocomplete="on"
            novalidate>
        <div>
          <label class="label" for="season">Season</label>
          <input id="season" name="season" type="number" inputmode="numeric" placeholder="2025" required>
        </div>
        <div>
          <label class="label" for="week">Week</label>
          <input id="week" name="week" type="number" inputmode="numeric" placeholder="12" required>
        </div>
        <div>
          <label class="label" for="title">Title</label>
          <input id="title" name="title" type="text" placeholder="Week 12 AP (Friends) Poll" required>
        </div>

        <div class="admin-actions">
          <button class="btn btn-primary" type="submit">Open Poll</button>
          <a class="btn" href="{{ url_for('poll.admin_panel') }}">Admin Panel</a>
        </div>
      </form>

      <form method="post" action="{{ url_for('poll.admin_seed_teams') }}" class="mt-2">
        <button class="btn sm" type="submit">Seed Teams</button>
      </form>
    </div>
  {% endif %}

</section>
{% endblock %}
