{% extends "base.html" %}
{% block title %}Vote – {{ poll.title }}{% endblock %}
{% block content %}

<section class="container">

  <!-- Sticky header that collapses while picker is open -->
  <header class="vote-bar sticky vote-bar--responsive" id="vote-header">
    <h1 class="vote-title">{{ poll.title }}</h1>
    <div class="vote-actions">
      <!-- Back removed -->
      <button id="autofill-defaults" class="btn btn-ghost sm" type="button" disabled>+ Default</button>
      <button id="clear-all" class="btn btn-ghost sm" type="button">Clear</button>
      <button form="vote-form" class="btn btn-primary sm" type="submit">Submit</button>
    </div>
  </header>

  <div class="vote-subbar">
    <span class="muted">Drag on desktop. On mobile: tap “+” in a slot to search and add a team.</span>
    <span class="muted" id="selection-count">0 of {{ MAX_RANK }} selected</span>
  </div>

  <form id="vote-form" class="vote-stack" method="post" action="{{ url_for('poll.submit_vote') }}">

    <!-- BALLOT -->
    <section class="card ballot">
      {# we’ll flatten all cells into one 3-col grid on mobile; keep original ranges for desktop #}
      {% set row1 = range(1, 10) %}
      {% set row2 = range(10, 18) %}
      {% set row3 = range(18, MAX_RANK + 1) %}

      <div class="rank-rows">
        <div class="rank-grid" style="--cols:9;">
          {% for r in row1 %}
          <div class="rank-cell" data-rank="{{ r }}">
            <div class="rank-num">#{{ r }}</div>
            <div class="rank-slot" data-rank="{{ r }}" tabindex="0" aria-label="Rank {{ r }}">
              <div class="rank-dropzone" data-rank="{{ r }}"></div>
              <button class="slot-add" type="button" data-open-picker data-rank="{{ r }}" aria-label="Add team to rank {{ r }}">+</button>
            </div>
            <div class="rank-controls" aria-hidden="true">
              <button class="rc rc-up"   type="button" title="Move up"   data-act="up">▲</button>
              <button class="rc rc-down" type="button" title="Move down" data-act="down">▼</button>
              <button class="rc rc-x"    type="button" title="Remove"    data-act="remove">✕</button>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="rank-grid" style="--cols:8;">
          {% for r in row2 %}
          <div class="rank-cell" data-rank="{{ r }}">
            <div class="rank-num">#{{ r }}</div>
            <div class="rank-slot" data-rank="{{ r }}" tabindex="0" aria-label="Rank {{ r }}">
              <div class="rank-dropzone" data-rank="{{ r }}"></div>
              <button class="slot-add" type="button" data-open-picker data-rank="{{ r }}" aria-label="Add team to rank {{ r }}">+</button>
            </div>
            <div class="rank-controls" aria-hidden="true">
              <button class="rc rc-up"   type="button" title="Move up"   data-act="up">▲</button>
              <button class="rc rc-down" type="button" title="Move down" data-act="down">▼</button>
              <button class="rc rc-x"    type="button" title="Remove"    data-act="remove">✕</button>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="rank-grid" style="--cols:8;">
          {% for r in row3 %}
          <div class="rank-cell" data-rank="{{ r }}">
            <div class="rank-num">#{{ r }}</div>
            <div class="rank-slot" data-rank="{{ r }}" tabindex="0" aria-label="Rank {{ r }}">
              <div class="rank-dropzone" data-rank="{{ r }}"></div>
              <button class="slot-add" type="button" data-open-picker data-rank="{{ r }}" aria-label="Add team to rank {{ r }}">+</button>
            </div>
            <div class="rank-controls" aria-hidden="true">
              <button class="rc rc-up"   type="button" title="Move up"   data-act="up">▲</button>
              <button class="rc rc-down" type="button" title="Move down" data-act="down">▼</button>
              <button class="rc rc-x"    type="button" title="Remove"    data-act="remove">✕</button>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div id="hidden-inputs"></div>
    </section>

    <!-- PALETTE -->
    <section class="card palette">
      <div class="palette-header">
        <h2 class="palette-title">Teams</h2>
        <input id="team-filter" class="input" type="text" placeholder="Filter teams…" aria-label="Filter teams" />
      </div>

      <div id="palette" class="logo-palette" aria-label="Teams">
        {% for t in teams %}
          {% set fname = logo_map.get(t.name) %}
          {% set img_src = fname and url_for('static', filename='images/logos/' ~ fname) or url_for('static', filename='images/logos/default.png') %}
          <div
            class="logo-card"
            draggable="true"
            data-team-id="{{ t.id }}"
            data-team-name="{{ t.name }}"
            data-file="{{ fname or '' }}"
            tabindex="0"
            aria-grabbed="false"
          >
            <img src="{{ img_src }}" alt="{{ t.name }} logo" onerror="this.src='{{ url_for('static', filename='images/logos/default.png') }}'">
            <div class="logo-name">{{ t.name }}</div>
          </div>
        {% endfor %}
      </div>

      <p class="muted tip">Tip: desktop drag between slots; double-click a placed logo to remove.</p>
    </section>
  </form>
</section>

<!-- Picker (mobile-first) -->
<div id="team-picker" class="picker hidden" role="dialog" aria-modal="true" aria-labelledby="picker-title">
  <div class="picker__panel">
    <div class="picker__head">
      <h3 id="picker-title">Choose a team</h3>
      <button class="btn btn-ghost sm" type="button" data-close-picker>Close</button>
    </div>
    <input id="picker-search" class="input picker__search" type="text" placeholder="Search teams…" aria-label="Search teams">
    <div id="picker-list" class="picker__list">
      {% for t in teams %}
        {% set fname = logo_map.get(t.name) %}
        {% set img_src = fname and url_for('static', filename='images/logos/' ~ fname) or url_for('static', filename='images/logos/default.png') %}
        <button class="picker__item" type="button"
                data-team-id="{{ t.id }}"
                data-team-name="{{ t.name }}"
                data-file="{{ fname or '' }}">
          <img src="{{ img_src }}" alt="" onerror="this.src='{{ url_for('static', filename='images/logos/default.png') }}'">
          <span>{{ t.name }}</span>
        </button>
      {% endfor %}
    </div>
  </div>
</div>

<style>
/* ---------- Header: responsive layout ---------- */
.vote-bar--responsive{
  display:flex; flex-direction:column; gap:10px; padding:10px 12px;
}
.vote-bar--responsive .vote-title{ font-size:1.1rem; line-height:1.2; }
.vote-bar--responsive .vote-actions{
  display:flex; flex-wrap:wrap; gap:8px; align-items:center;
}
@media (min-width: 769px){
  .vote-bar--responsive{ flex-direction:row; align-items:center; justify-content:space-between; }
  .vote-bar--responsive .vote-title{ font-size:1.25rem; }
  .vote-bar--responsive .vote-actions{ flex-wrap:nowrap; }
}

/* Hide the sticky header entirely while picker is open */
.picker-open #vote-header{ display:none; }

/* strike-through look when “+ Default” is disabled */
.btn.line-through{ text-decoration:line-through; text-decoration-thickness:2px; opacity:.6; }

/* ---------- Ballot layout ---------- */
@media (max-width: 768px){
  /* Flatten all children into a single 3-col grid so 1..25 flow with no gaps */
  .rank-rows{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 8px;
  }
  .rank-grid{ display:contents; } /* collapse wrappers */
}
@media (min-width: 769px){
  .rank-rows{ display:flex; flex-direction:column; gap:12px; }
  .rank-grid{
    display:grid;
    grid-template-columns: repeat(var(--cols, 8), minmax(0,1fr));
    gap:10px;
  }
}

/* slot add button */
.slot-add{
  display:none;
  position:absolute; inset:0;
  margin:auto; width:42px; height:42px; border-radius:999px;
  background:var(--panel-3, #1b1f29); color:var(--fg, #eaeef7);
  border:1px solid var(--line); font-size:1.4rem; line-height:1;
  opacity:.9; transition:transform .12s ease, opacity .12s ease;
}
.slot-add:active{ transform:scale(.96) }
.rank-slot{ position:relative }
@media (max-width: 768px){
  .rank-controls{ display:none !important; }
  .slot-add{ display:grid; place-items:center; }
}

/* ---------- Picker anchored to TOP ---------- */
.picker.hidden{ display:none; }
.picker{
  position:fixed; inset:0; z-index:50;
  background:rgba(0,0,0,.45);
  display:grid; place-items:start center;
  padding-top:max(8px, env(safe-area-inset-top));
}
.picker__panel{
  width:100%; max-width:720px; background:var(--panel-2, #10141c);
  border-radius:16px; border:1px solid var(--line);
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  max-height:100dvh;
  display:flex; flex-direction:column;
}
.picker__head{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px 12px 0 12px; }
.picker__search{ margin:10px 12px 0 12px; }
.picker__list{
  overflow:auto; padding:12px; gap:8px;
  display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr));
  flex:1 1 auto;
}
.picker__item{
  display:flex; align-items:center; gap:10px;
  background:var(--panel-1, #0c111a);
  border:1px solid var(--line); border-radius:10px;
  padding:8px 10px; cursor:pointer; text-align:left;
}
.picker__item img{ width:28px; height:28px; object-fit:contain; }
.picker__item:hover{ outline:2px solid rgba(147,197,253,.35); outline-offset:-2px; }

/* Keep sticky header colored */
.vote-bar.sticky{ background:var(--panel-2); border-bottom:1px solid var(--line); }

/* subtle + hides when filled */
.slot-add{ opacity:.55; transition:opacity .12s ease, transform .12s ease; z-index:1; }
.badge{ position:relative; z-index:2; }
.rank-slot.filled .slot-add{ opacity:0; pointer-events:none; }
</style>

<script>
(function(){
  // ---- Config from server ----
  const MAX_RANK    = {{ MAX_RANK }};
  const LOGO_BASE   = "{{ url_for('static', filename='images/logos/') }}";
  const RANK_MAP    = {{ (rank_map or {}) | tojson }};
  const DEFAULT_MAP = {{ (default_rank_map or {}) | tojson }};

  // Flat team index
  const TEAMS = [
    {% for t in teams %}
      { id: {{ t.id }}, name: {{ t.name|tojson }}, file: {{ (logo_map.get(t.name) or '')|tojson }} },
    {% endfor %}
  ].reduce((a,t)=>{ a[String(t.id)] = t; return a; }, {});

  // ---- DOM ----
  const form           = document.getElementById('vote-form');
  const hiddenInputs   = document.getElementById('hidden-inputs');
  const dropzones      = Array.from(document.querySelectorAll('.rank-dropzone'));
  const rankCells      = Array.from(document.querySelectorAll('.rank-cell'));
  const palette        = document.getElementById('palette');
  const filterInput    = document.getElementById('team-filter');
  const clearBtn       = document.getElementById('clear-all');
  const selectionCount = document.getElementById('selection-count');
  const picker         = document.getElementById('team-picker');
  const pickerSearch   = document.getElementById('picker-search');
  const pickerList     = document.getElementById('picker-list');
  const autofillBtn    = document.getElementById('autofill-defaults');

  let pickerTargetRank = null;

  // ---- Helpers ----
  function slotFromZone(z){ return z?.closest('.rank-slot') || null; }
  function isBallotEmpty(){ return dropzones.every(z => !z.firstElementChild); }

  function updateAutofillState(){
    if (!autofillBtn) return;
    const hasDefaults = DEFAULT_MAP && Object.keys(DEFAULT_MAP).length > 0;
    const canUse = hasDefaults && isBallotEmpty();
    autofillBtn.disabled = !canUse;
    autofillBtn.classList.toggle('line-through', !canUse);
    autofillBtn.setAttribute('aria-disabled', String(!canUse));
  }

  function updateCount(){
    const selected = dropzones.reduce((n, z) => n + (z.firstElementChild ? 1 : 0), 0);
    if (selectionCount) selectionCount.textContent = selected + ' of ' + MAX_RANK + ' selected';
    updateAutofillState();
  }

  function updateSlotState(slot){
    if (!slot) return;
    const zone = slot.querySelector('.rank-dropzone');
    zone?.firstElementChild ? slot.classList.add('filled') : slot.classList.remove('filled');
  }

  function removeIfPlaced(teamId){
    dropzones.forEach(z => {
      const kid = z.firstElementChild;
      if (kid && kid.dataset.teamId === String(teamId)) {
        z.innerHTML = '';
        updateSlotState(slotFromZone(z));
      }
    });
  }

  function createBadge(teamId, teamName, fileName){
    const div = document.createElement('div');
    div.className = 'badge badge--img-only';
    div.setAttribute('draggable', 'true');
    div.dataset.teamId = String(teamId);
    div.dataset.teamName = teamName;
    if (fileName) div.dataset.file = fileName;

    const img = document.createElement('img');
    img.className = 'badge-logo';
    img.alt = teamName + ' logo';
    img.src = fileName ? (LOGO_BASE + fileName) : (LOGO_BASE + 'default.png');
    img.onerror = () => { img.src = LOGO_BASE + 'default.png'; };
    div.appendChild(img);

    div.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', JSON.stringify({
        teamId: div.dataset.teamId, teamName: div.dataset.teamName, file: div.dataset.file || ''
      }));
      e.dataTransfer.effectAllowed = 'move';
    });

    div.addEventListener('dblclick', () => {
      const slot = div.closest('.rank-dropzone');
      if (slot) {
        slot.innerHTML = '';
        updateSlotState(slotFromZone(slot));
      }
      updateCount();
    });

    // mobile: tap to re-open picker for that rank
    div.addEventListener('click', () => {
      if (window.matchMedia('(max-width: 768px)').matches) {
        const slot = div.closest('.rank-slot');
        if (slot) openPickerForRank(slot.dataset.rank);
      }
    });

    return div;
  }

  function placeInZone(zone, data){
    if (!zone) return;
    removeIfPlaced(data.teamId);
    zone.innerHTML = '';
    zone.appendChild(createBadge(data.teamId, data.teamName, data.file || ''));
    updateSlotState(slotFromZone(zone));
    updateCount();
  }

  function nextEmptyZone(){ return dropzones.find(z => !z.firstElementChild); }

  // palette drag + keyboard
  document.querySelectorAll('.logo-card').forEach(card => {
    const payload = () => ({ teamId: card.dataset.teamId, teamName: card.dataset.teamName, file: card.dataset.file || '' });

    card.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', JSON.stringify(payload()));
      e.dataTransfer.effectAllowed = 'copyMove';
    });

    card.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const target = nextEmptyZone(); if (!target) return;
        placeInZone(target, payload());
      }
    });
  });

  // DnD targets
  document.addEventListener('dragover', function(e){
    const slot = e.target.closest('.rank-slot'); if (!slot) return;
    const zone = slot.querySelector('.rank-dropzone'); if (!zone) return;
    e.preventDefault(); zone.classList.add('rank-dropzone--hover');
  });
  document.addEventListener('dragleave', function(e){
    const slot = e.target.closest('.rank-slot'); if (!slot) return;
    const zone = slot.querySelector('.rank-dropzone'); if (!zone) return;
    if (!slot.contains(e.relatedTarget)) zone.classList.remove('rank-dropzone--hover');
  });
  document.addEventListener('drop', function(e){
    const slot = e.target.closest('.rank-slot'); if (!slot) return;
    const zone = slot.querySelector('.rank-dropzone'); if (!zone) return;
    e.preventDefault(); zone.classList.remove('rank-dropzone--hover');
    let data; try { data = JSON.parse(e.dataTransfer.getData('text/plain')); } catch(_){}
    if (!data || !data.teamId) return;
    placeInZone(zone, data);
  });

  // inline rank controls
  rankCells.forEach(cell => {
    const zone = cell.querySelector('.rank-dropzone');
    const up   = cell.querySelector('[data-act="up"]');
    const down = cell.querySelector('[data-act="down"]');
    const x    = cell.querySelector('[data-act="remove"]');

    function move(delta){
      const from = parseInt(cell.dataset.rank, 10);
      const to   = from + delta;
      if (to < 1 || to > MAX_RANK) return;
      const toZone = document.querySelector('.rank-dropzone[data-rank="'+to+'"]');
      if (!zone.firstElementChild) return;
      const data = {
        teamId: zone.firstElementChild.dataset.teamId,
        teamName: zone.firstElementChild.dataset.teamName,
        file: zone.firstElementChild.dataset.file || ''
      };
      zone.innerHTML = '';
      updateSlotState(slotFromZone(zone));
      placeInZone(toZone, data);
      toZone.closest('.rank-cell')?.scrollIntoView({ behavior:'smooth', block:'center' });
    }

    up?.addEventListener('click', () => move(-1));
    down?.addEventListener('click', () => move(1));
    x?.addEventListener('click', () => {
      zone.innerHTML = '';
      updateSlotState(slotFromZone(zone));
      updateCount();
    });
  });

  // ----- Picker (hide sticky header while open) -----
  function openPickerForRank(rankStr){
    pickerTargetRank = String(rankStr);
    document.documentElement.classList.add('picker-open');  // hides header
    picker.classList.remove('hidden');
    if (pickerSearch) {
      pickerSearch.value = '';
      filterPicker('');
      setTimeout(()=>{
        pickerSearch.focus();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 0);
    }
  }
  function closePicker(){
    picker.classList.add('hidden');
    document.documentElement.classList.remove('picker-open');
    pickerTargetRank = null;
  }
  document.querySelectorAll('[data-open-picker]').forEach(btn => btn.addEventListener('click', () => openPickerForRank(btn.dataset.rank)));
  document.querySelectorAll('[data-close-picker]').forEach(btn => btn.addEventListener('click', closePicker));
  picker.addEventListener('click', (e) => { if (e.target === picker) closePicker(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !picker.classList.contains('hidden')) closePicker(); });

  function filterPicker(q){
    const qq = (q || '').toLowerCase().trim();
    pickerList?.querySelectorAll('.picker__item').forEach(item => {
      const name = (item.dataset.teamName || '').toLowerCase();
      item.style.display = name.includes(qq) ? '' : 'none';
    });
  }
  pickerSearch?.addEventListener('input', (e) => filterPicker(e.target.value));

  pickerList?.addEventListener('click', (e) => {
    const btn = e.target.closest('.picker__item');
    if (!btn || !pickerTargetRank) return;
    const zone = document.querySelector('.rank-dropzone[data-rank="'+ pickerTargetRank +'"]');
    if (!zone) return;
    placeInZone(zone, { teamId: btn.dataset.teamId, teamName: btn.dataset.teamName, file: btn.dataset.file || '' });
    closePicker();
    document.querySelector('.rank-cell[data-rank="'+ pickerTargetRank +'"]')?.scrollIntoView({ behavior:'smooth', block:'center' });
  });

  // palette filter
  function filterPalette(){
    const q = (filterInput?.value || '').toLowerCase().trim();
    palette?.querySelectorAll('.logo-card').forEach(c => {
      const name = (c.dataset.teamName || '').toLowerCase();
      c.style.display = name.includes(q) ? '' : 'none';
    });
  }
  filterInput?.addEventListener('input', filterPalette);

  // clear all
  clearBtn?.addEventListener('click', () => {
    dropzones.forEach(z => { z.innerHTML = ''; updateSlotState(slotFromZone(z)); });
    updateCount();
  });

  // autofill defaults
  function applyDefaults(){
    if (!DEFAULT_MAP || !isBallotEmpty()) return;
    for (let r = 1; r <= MAX_RANK; r++){
      const teamId = DEFAULT_MAP[String(r)] || DEFAULT_MAP[r];
      if (!teamId) continue;
      const team = TEAMS[String(teamId)];
      const zone = document.querySelector('.rank-dropzone[data-rank="'+ r +'"]');
      if (!team || !zone) continue;
      placeInZone(zone, { teamId: team.id, teamName: team.name, file: team.file || '' });
    }
  }
  autofillBtn?.addEventListener('click', () => { if (isBallotEmpty()) applyDefaults(); });

  // prefill saved ballot
  (function prefill(){
    if (!RANK_MAP || typeof RANK_MAP !== 'object') { updateCount(); return; }
    Object.keys(RANK_MAP).forEach(rank => {
      const teamId = String(RANK_MAP[rank]);
      const meta = TEAMS[teamId];
      const zone = document.querySelector('.rank-dropzone[data-rank="'+ rank +'"]');
      if (zone && meta) {
        zone.innerHTML = '';
        zone.appendChild(createBadge(meta.id, meta.name, meta.file));
        updateSlotState(slotFromZone(zone));
      }
    });
    dropzones.forEach(z => updateSlotState(slotFromZone(z)));
    updateCount();
  }());

  // submit -> hidden inputs
  form?.addEventListener('submit', () => {
    hiddenInputs.innerHTML = '';
    dropzones.forEach(z => {
      const rank = z.dataset.rank;
      const kid  = z.firstElementChild;
      if (kid && rank) {
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = 'rank_' + rank;
        inp.value = kid.dataset.teamId;
        hiddenInputs.appendChild(inp);
      }
    });
  });

  // logs
  console.log('[VotePage] init');
  console.log('[VotePage] MAX_RANK:', MAX_RANK);
  console.log('[VotePage] RANK_MAP:', RANK_MAP);
  console.log('[VotePage] DEFAULT_MAP:', DEFAULT_MAP);
  console.log('[VotePage] TEAMS count:', Object.keys(TEAMS).length);
})();
</script>

{% endblock %}
