{% extends "base.html" %}

{% block title %}{{ poll.title }} - Results - CLAAMP{% endblock %}

{% block content %}
<div class="container">
  <div class="page-header" style="text-align: center; margin-bottom: 2rem;">
    <h1>{{ poll.title }} - Results</h1>
    <p class="muted">Season {{ poll.season }}, Week {{ poll.week }}</p>
  </div>

  <!-- Leaderboard -->
  {% if leaderboard %}
    <div class="card" style="margin-bottom: 2rem;">
      <div class="card-header">
        <h2 style="margin: 0; font-size: 1.25rem;">Leaderboard</h2>
      </div>
      <div class="card-body" style="padding: 0;">
        <!-- Desktop table -->
        <table class="leaderboard-table desktop-only">
          <thead>
            <tr>
              <th>Rank</th>
              <th>User</th>
              <th>W-L</th>
              <th>Win %</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in leaderboard %}
              <tr {% if entry.user.id == current_user.id %}class="highlight-row"{% endif %}>
                <td><strong>{{ loop.index }}</strong></td>
                <td>
                  <strong>{{ entry.user.username }}</strong>
                  {% if entry.user.id == current_user.id %}
                    <span class="badge badge-primary" style="margin-left: 0.5rem;">You</span>
                  {% endif %}
                </td>
                <td>
                  <span class="correct-text">{{ entry.correct }}</span>-<span class="incorrect-text">{{ entry.incorrect }}</span>
                  {% if entry.pending > 0 %}
                    <span class="muted" style="margin-left: 0.25rem;">({{ entry.pending }} pending)</span>
                  {% endif %}
                </td>
                <td>
                  {% if entry.total > 0 %}
                    <strong>{{ "%.1f"|format(entry.pct) }}%</strong>
                  {% else %}
                    <span class="muted">-</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- Mobile cards -->
        <div class="leaderboard-mobile mobile-only">
          {% for entry in leaderboard %}
            <div class="leaderboard-card {% if entry.user.id == current_user.id %}highlight-card{% endif %}">
              <div class="leaderboard-rank">{{ loop.index }}</div>
              <div class="leaderboard-info">
                <div class="leaderboard-user">
                  <strong>{{ entry.user.username }}</strong>
                  {% if entry.user.id == current_user.id %}
                    <span class="badge badge-primary">You</span>
                  {% endif %}
                </div>
                <div class="leaderboard-stats">
                  <span class="correct-text">{{ entry.correct }}W</span>
                  <span class="muted">-</span>
                  <span class="incorrect-text">{{ entry.incorrect }}L</span>
                  {% if entry.total > 0 %}
                    <span class="muted">·</span>
                    <strong>{{ "%.0f"|format(entry.pct) }}%</strong>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Games by day -->
  {% if games_by_day %}
    <h2 style="margin-top: 3rem; margin-bottom: 1rem;">Games</h2>

    {% for day, games in games_by_day.items()|sort %}
      <div class="day-header">
        <h3>{{ day }}</h3>
      </div>

      {% for game in games %}
        {% set away_logo = logo_map.get(game.away_team.name, 'default.png') %}
        {% set home_logo = logo_map.get(game.home_team.name, 'default.png') %}

        <div class="game-result-card">
          <!-- Game header with teams and scores -->
          <div class="game-matchup">
            <div class="game-team away-team">
              <div class="logo-wrapper-sm">
                <img src="{{ url_for('static', filename='images/logos/' + away_logo) }}"
                     alt="{{ game.away_team.name }}"
                     class="team-logo-sm">
              </div>
              <div class="team-details">
                <span class="team-name">{{ game.away_team.name }}</span>
                <span class="team-spread">{{ game.away_spread }}</span>
              </div>
              {% if game.away_score is not none %}
                <strong class="score">{{ game.away_score }}</strong>
              {% endif %}
            </div>

            <div class="vs-divider">@</div>

            <div class="game-team home-team">
              {% if game.home_score is not none %}
                <strong class="score">{{ game.home_score }}</strong>
              {% endif %}
              <div class="team-details">
                <span class="team-name">{{ game.home_team.name }}</span>
                <span class="team-spread">{{ game.home_spread }}</span>
              </div>
              <div class="logo-wrapper-sm">
                <img src="{{ url_for('static', filename='images/logos/' + home_logo) }}"
                     alt="{{ game.home_team.name }}"
                     class="team-logo-sm">
              </div>
            </div>
          </div>

          <!-- Status badge -->
          <div class="game-status-bar">
            {% if game.status == 'final' %}
              <span class="badge badge-success">Final</span>
            {% elif game.status == 'in_progress' %}
              <span class="badge badge-warning">In Progress</span>
            {% else %}
              <span class="badge badge-secondary">Scheduled</span>
            {% endif %}
          </div>

          <!-- Picks summary -->
          {% if game.picks %}
            <div class="picks-summary">
              <div class="picks-header">
                <span class="picks-count">{{ game.picks|length }} pick{{ 's' if game.picks|length != 1 else '' }}</span>
              </div>

              <div class="picks-grid">
                {% for pick in game.picks %}
                  {% set is_correct = pick.is_correct %}
                  {% set is_home = pick.picked_team_id == game.home_team_id %}

                  <div class="pick-chip {% if is_correct == true %}correct{% elif is_correct == false %}incorrect{% endif %}">
                    <span class="pick-user">{{ pick.user.username }}</span>
                    <span class="pick-arrow">→</span>
                    <span class="pick-team">{{ (game.home_team.name if is_home else game.away_team.name)[:15] }}</span>
                    {% if is_correct == true %}
                      <span class="pick-icon">✓</span>
                    {% elif is_correct == false %}
                      <span class="pick-icon">✗</span>
                    {% else %}
                      <span class="pick-icon muted">-</span>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% endfor %}
  {% else %}
    <p class="muted">No games available.</p>
  {% endif %}

  <div style="margin-top: 2rem; text-align: center;">
    <a href="{{ url_for('spreads.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
  </div>
</div>

<style>
  /* Show/hide for responsive */
  .desktop-only { display: table; }
  .mobile-only { display: none; }

  /* Desktop leaderboard table */
  .leaderboard-table {
    width: 100%;
    border-collapse: collapse;
  }

  .leaderboard-table th,
  .leaderboard-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #1f2937;
  }

  .leaderboard-table th {
    background: #141b26;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    color: #9ca3af;
  }

  .leaderboard-table tbody tr:hover {
    background: #141b2633;
  }

  .highlight-row {
    background: #6ee7ff11;
  }

  .correct-text {
    color: #10b981;
    font-weight: 600;
  }

  .incorrect-text {
    color: #ef4444;
    font-weight: 600;
  }

  /* Mobile leaderboard cards */
  .leaderboard-mobile {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 0.75rem;
  }

  .leaderboard-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.875rem;
    background: #1f2937;
    border-radius: 0.5rem;
  }

  .highlight-card {
    background: #6ee7ff11;
    border: 1px solid #6ee7ff33;
  }

  .leaderboard-rank {
    font-size: 1.25rem;
    font-weight: 700;
    color: #6ee7ff;
    min-width: 2rem;
    text-align: center;
  }

  .leaderboard-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .leaderboard-user {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .leaderboard-stats {
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .day-header {
    margin: 2rem 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #2a3441;
  }

  .day-header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #6ee7ff;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Game cards */
  .game-result-card {
    background: #141b26;
    border: 1px solid #2a3441;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .game-matchup {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }

  .game-team {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
  }

  .away-team {
    justify-content: flex-start;
  }

  .home-team {
    justify-content: flex-end;
  }

  .logo-wrapper-sm {
    background: #2a3441;
    border-radius: 0.375rem;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .team-logo-sm {
    width: 32px;
    height: 32px;
    object-fit: contain;
  }

  .team-details {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .team-name {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .team-spread {
    font-size: 0.75rem;
    color: #9ca3af;
    font-family: ui-monospace, monospace;
  }

  .score {
    font-size: 1.5rem;
    font-weight: 700;
    color: #6ee7ff;
    min-width: 2.5rem;
    text-align: center;
  }

  .vs-divider {
    color: #6b7280;
    font-weight: 600;
    font-size: 0.75rem;
    flex-shrink: 0;
  }

  .game-status-bar {
    margin-bottom: 1rem;
    display: flex;
    justify-content: center;
  }

  /* Picks */
  .picks-summary {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #2a3441;
  }

  .picks-header {
    margin-bottom: 0.75rem;
  }

  .picks-count {
    font-size: 0.875rem;
    color: #9ca3af;
    font-weight: 600;
  }

  .picks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 0.5rem;
  }

  .pick-chip {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: #1f2937;
    border-radius: 0.375rem;
    font-size: 0.8rem;
    border-left: 3px solid transparent;
  }

  .pick-chip.correct {
    background: #10b98122;
    border-left-color: #10b981;
  }

  .pick-chip.incorrect {
    background: #ef444422;
    border-left-color: #ef4444;
  }

  .pick-user {
    font-weight: 600;
    flex-shrink: 0;
  }

  .pick-arrow {
    color: #6b7280;
    flex-shrink: 0;
  }

  .pick-team {
    color: #9ca3af;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .pick-icon {
    font-size: 1.1rem;
    font-weight: bold;
    flex-shrink: 0;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-primary {
    background: #6ee7ff;
    color: #0c111a;
  }

  .badge-success {
    background: #10b981;
    color: #fff;
  }

  .badge-warning {
    background: #f59e0b;
    color: #fff;
  }

  .badge-secondary {
    background: #6b7280;
    color: #fff;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .desktop-only { display: none !important; }
    .mobile-only { display: flex !important; }

    .game-matchup {
      gap: 0.5rem;
    }

    .team-name {
      font-size: 0.85rem;
    }

    .team-logo-sm {
      width: 28px;
      height: 28px;
    }

    .score {
      font-size: 1.25rem;
      min-width: 2rem;
    }

    .picks-grid {
      grid-template-columns: 1fr;
    }

    .pick-chip {
      font-size: 0.85rem;
    }
  }

  @media (max-width: 480px) {
    .game-result-card {
      padding: 0.875rem;
    }

    .team-details {
      min-width: 0;
      overflow: hidden;
    }

    .team-name {
      font-size: 0.8rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 120px;
    }

    .team-spread {
      font-size: 0.7rem;
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
    }
  }
</style>
{% endblock %}
