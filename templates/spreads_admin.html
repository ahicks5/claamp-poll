{% extends "base.html" %}

{% block title %}Spreads Admin - TakeFreePoints{% endblock %}

{% block content %}
<div class="container">
  <div class="page-header">
    <h1>Spreads Admin Panel</h1>
    <p class="muted">Manage spread polls and games</p>
  </div>

  <!-- Instructions -->
  <div class="alert alert-info" style="margin-bottom: 2rem;">
    <h3 style="margin-top: 0;">How to manage spreads:</h3>
    <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
      <li>Run <code>python ingest_spreads.py</code> to fetch games from Bovada</li>
      <li>This will automatically create/update the weekly spread poll</li>
      <li>Games and spreads will be updated each time you run the script</li>
      <li>Close polls manually when voting should end</li>
    </ol>
  </div>

  <!-- Spread Polls List -->
  <div class="card">
    <div class="card-header">
      <h2 style="margin: 0; font-size: 1.25rem;">Spread Polls</h2>
    </div>

    {% if poll_data %}
      <div class="card-body" style="padding: 0;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Week</th>
              <th>Title</th>
              <th>Status</th>
              <th>Games</th>
              <th>Picks</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for item in poll_data %}
              {% set poll = item.poll %}
              <tr>
                <td>
                  <strong>S{{ poll.season }}W{{ poll.week }}</strong>
                </td>
                <td>{{ poll.title }}</td>
                <td>
                  {% if poll.is_open %}
                    <span class="badge badge-success">Open</span>
                  {% else %}
                    <span class="badge badge-secondary">Closed</span>
                  {% endif %}
                </td>
                <td>{{ item.game_count }}</td>
                <td>{{ item.pick_count }}</td>
                <td class="muted">{{ poll.created_at.strftime('%Y-%m-%d %H:%M') if poll.created_at else 'N/A' }}</td>
                <td>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <a href="{{ url_for('spreads.results', season=poll.season, week=poll.week) }}"
                       class="btn btn-sm btn-secondary">View</a>

                    {% if poll.is_open %}
                      <form method="POST"
                            action="{{ url_for('spreads.close_poll', poll_id=poll.id) }}"
                            style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-warning"
                                onclick="return confirm('Close this poll? Users will no longer be able to make picks.');">
                          Close
                        </button>
                      </form>
                    {% else %}
                      <form method="POST"
                            action="{{ url_for('spreads.open_poll', poll_id=poll.id) }}"
                            style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-primary"
                                onclick="return confirm('Re-open this poll?');">
                          Re-open
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="card-body">
        <p class="muted">No spread polls created yet.</p>
        <p class="muted">Run <code>python ingest_spreads.py</code> to create the first poll.</p>
      </div>
    {% endif %}
  </div>

  <!-- Ingestion Command Reference -->
  <div class="card" style="margin-top: 2rem;">
    <div class="card-header">
      <h2 style="margin: 0; font-size: 1.25rem;">Ingestion Script Reference</h2>
    </div>
    <div class="card-body">
      <p><strong>Manual run:</strong></p>
      <pre><code>python ingest_spreads.py</code></pre>

      <p style="margin-top: 1rem;"><strong>Heroku Scheduler (hourly):</strong></p>
      <pre><code>python ingest_spreads.py</code></pre>

      <p style="margin-top: 1rem;" class="muted">
        The script will automatically create the weekly poll and update game spreads from Bovada.
        Make sure to update the CURRENT_SEASON and CURRENT_WEEK variables in the script.
      </p>
    </div>
  </div>

  <div style="margin-top: 2rem;">
    <a href="{{ url_for('spreads.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
  </div>
</div>

<style>
  .alert-info {
    background: #3b82f633;
    border: 1px solid #3b82f6;
    border-radius: 0.5rem;
    padding: 1.5rem;
  }

  .admin-table {
    width: 100%;
    border-collapse: collapse;
  }

  .admin-table th,
  .admin-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #1f2937;
  }

  .admin-table th {
    background: #141b26;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    color: #9ca3af;
  }

  .admin-table tbody tr:hover {
    background: #141b2633;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-success {
    background: #10b981;
    color: #fff;
  }

  .badge-secondary {
    background: #6b7280;
    color: #fff;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
  }

  .btn-warning {
    background: #f59e0b;
    color: #fff;
    border: none;
  }

  .btn-warning:hover {
    background: #d97706;
  }

  pre {
    background: #1f2937;
    padding: 1rem;
    border-radius: 0.375rem;
    overflow-x: auto;
  }

  code {
    font-family: ui-monospace, monospace;
    color: #6ee7ff;
  }

  @media (max-width: 768px) {
    .admin-table {
      font-size: 0.875rem;
    }

    .admin-table th,
    .admin-table td {
      padding: 0.5rem;
    }

    .admin-table th:nth-child(6),
    .admin-table td:nth-child(6) {
      display: none;
    }
  }
</style>
{% endblock %}
